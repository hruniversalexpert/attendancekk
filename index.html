<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Expert HR - Complete Attendance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-blue: #1a73e8;
            --dark-blue: #0d47a1;
            --light-blue: #e8f0fe;
            --white: #ffffff;
            --gray: #f5f5f5;
            --dark-gray: #5f6368;
            --red: #ea4335;
            --green: #34a853;
            --yellow: #f9ab00;
            --orange: #ff9800;
            --purple: #8e44ad;
            --pink: #e91e63;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--primary-blue);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
        
        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            background: var(--gray);
        }
        
        .login-tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-tab.active {
            background: var(--primary-blue);
            color: white;
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-group input:focus {
            border-color: var(--primary-blue);
            outline: none;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background: var(--dark-blue);
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-blue);
            font-size: 20px;
        }
        
        .company-info h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .company-info p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .welcome-message {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* Staff Dashboard */
        .staff-dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        
        @media (min-width: 1200px) {
            .staff-dashboard {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Staff Info Card */
        .staff-info-card {
            background: linear-gradient(135deg, var(--light-blue), #dbeafe);
            padding: 25px;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-blue);
        }
        
        .staff-info-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .staff-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid white;
            box-shadow: var(--shadow);
            background: var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .staff-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .staff-avatar .initials {
            font-size: 36px;
            font-weight: bold;
            color: white;
        }
        
        .staff-details h3 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--dark-blue);
        }
        
        .staff-details p {
            margin-bottom: 5px;
            color: var(--dark-gray);
        }
        
        /* Action Buttons */
        .action-panel {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .action-btn {
            padding: 20px 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .action-btn i {
            font-size: 24px;
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-login { background: var(--green); color: white; }
        .btn-logout { background: var(--red); color: white; }
        .btn-tea { background: var(--yellow); color: #333; }
        .btn-lunch { background: var(--orange); color: white; }
        .btn-work { background: var(--primary-blue); color: white; }
        .btn-break-end { background: var(--purple); color: white; }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Today's Timeline */
        .timeline {
            margin-top: 20px;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary-blue);
        }
        
        .timeline-time {
            font-weight: 600;
            color: var(--primary-blue);
            min-width: 80px;
        }
        
        .timeline-activity {
            flex: 1;
            padding-left: 15px;
        }
        
        .timeline-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-login { background: #d4edda; color: #155724; }
        .status-logout { background: #f8d7da; color: #721c24; }
        .status-break { background: #fff3cd; color: #856404; }
        .status-work { background: #d1ecf1; color: #0c5460; }
        
        /* Daily Display */
        .daily-display {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 25px;
        }
        
        .daily-header {
            background: var(--primary-blue);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .daily-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-top: 25px;
        }
        
        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .admin-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .admin-btn.export { background: var(--green); color: white; }
        .admin-btn.reset { background: var(--red); color: white; }
        .admin-btn.backup { background: var(--orange); color: white; }
        .admin-btn.manage { background: var(--purple); color: white; }
        .admin-btn.report { background: var(--pink); color: white; }
        
        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Report Section */
        .report-section {
            background: var(--light-blue);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-top: 25px;
        }
        
        .report-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: var(--dark-blue);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 5px solid;
        }
        
        .stat-card:nth-child(1) { border-color: var(--green); }
        .stat-card:nth-child(2) { border-color: var(--yellow); }
        .stat-card:nth-child(3) { border-color: var(--red); }
        .stat-card:nth-child(4) { border-color: var(--primary-blue); }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        /* Attendance Table */
        .attendance-table {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 25px;
        }
        
        .table-header {
            background: var(--primary-blue);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-responsive {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th {
            background: var(--primary-blue);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: var(--light-blue);
        }
        
        .staff-photo-cell {
            width: 50px;
            text-align: center;
        }
        
        .staff-photo-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--light-blue);
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-present { background: #d4edda; color: #155724; }
        .badge-absent { background: #f8d7da; color: #721c24; }
        .badge-late { background: #fff3cd; color: #856404; }
        .badge-break { background: #d1ecf1; color: #0c5460; }
        
        /* Photo Upload */
        .photo-upload {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
        }
        
        .photo-upload input[type="file"] {
            display: none;
        }
        
        .photo-upload label {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary-blue);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-blue);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 10000;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 5px solid var(--green);
        }
        
        .toast.error {
            border-left: 5px solid var(--red);
        }
        
        .toast.warning {
            border-left: 5px solid var(--yellow);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 30px;
        }
        
        .tab {
            flex: 1;
            padding: 18px 20px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }
        
        .tab.active {
            color: var(--primary-blue);
            background: var(--light-blue);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-blue);
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--dark-gray);
            font-size: 14px;
            margin-top: 50px;
            border-top: 1px solid #eee;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
            }
            
            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .staff-dashboard {
                grid-template-columns: 1fr;
            }
            
            .admin-controls {
                grid-template-columns: 1fr;
            }
            
            .report-filters {
                grid-template-columns: 1fr;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">UEH</div>
            <h2>Universal Expert HR</h2>
            <p style="color: var(--dark-gray); margin-bottom: 30px;">Attendance System Login</p>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="showLoginForm('staff')">Staff Login</button>
                <button class="login-tab" onclick="showLoginForm('admin')">Admin Login</button>
            </div>
            
            <!-- Staff Login Form -->
            <div class="login-form active" id="staffLoginForm">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Staff ID</label>
                    <input type="text" id="staffUsername" placeholder="Enter your staff ID">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="staffPassword" placeholder="Enter password">
                </div>
                <button class="login-btn" onclick="staffLogin()">
                    <i class="fas fa-sign-in-alt"></i> Login as Staff
                </button>
                <p style="margin-top: 15px; color: var(--dark-gray); font-size: 14px;">
                    Example: karan123 / karan123
                </p>
            </div>
            
            <!-- Admin Login Form -->
            <div class="login-form" id="adminLoginForm">
                <div class="form-group">
                    <label><i class="fas fa-user-shield"></i> Admin Username</label>
                    <input type="text" id="adminUsername" placeholder="Enter admin username">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Admin Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password">
                </div>
                <button class="login-btn" onclick="adminLogin()">
                    <i class="fas fa-sign-in-alt"></i> Login as Admin
                </button>
            </div>
            
            <p id="loginError" style="color: var(--red); margin-top: 15px; display: none;">
                <i class="fas fa-exclamation-circle"></i> Invalid credentials
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-container">
                <div class="logo-section">
                    <div class="logo">UEH</div>
                    <div class="company-info">
                        <h1>Universal Expert HR</h1>
                        <p>Complete Attendance System</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="welcome-message" id="welcomeMessage"></div>
                    <div class="live-time" id="currentDateTime"></div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <div class="container">
            <!-- Staff Dashboard -->
            <div id="staffDashboard">
                <div class="staff-dashboard">
                    <!-- Staff Info -->
                    <div class="staff-info-card">
                        <div class="staff-info-header">
                            <div class="staff-avatar" id="staffAvatar">
                                <img id="staffPhoto" src="" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="initials" id="staffInitials">K</div>
                            </div>
                            <div class="staff-details">
                                <h3 id="staffName">Karan Sharma</h3>
                                <p><i class="fas fa-id-card"></i> Staff ID: <span id="staffId">karan123</span></p>
                                <p><i class="fas fa-building"></i> Department: <span id="staffDept">Management</span></p>
                                <p><i class="fas fa-calendar"></i> Date: <span id="todayDate">--</span></p>
                                <p><i class="fas fa-clock"></i> Status: <span id="currentStatusText">Not checked in</span></p>
                            </div>
                        </div>
                        
                        <div class="timeline">
                            <h4><i class="fas fa-history"></i> Today's Activity Timeline</h4>
                            <div id="todayTimeline">
                                <!-- Timeline items will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Action Panel -->
                    <div class="action-panel">
                        <h3><i class="fas fa-user-clock"></i> Mark Your Attendance</h3>
                        <div class="action-buttons">
                            <button class="action-btn btn-login" onclick="markAttendance('LOGIN')" id="btnLogin">
                                <i class="fas fa-sign-in-alt"></i>
                                <span>Login</span>
                            </button>
                            <button class="action-btn btn-logout" onclick="markAttendance('LOGOUT')" id="btnLogout" disabled>
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                            <button class="action-btn btn-tea" onclick="markAttendance('TEA_BREAK')" id="btnTea" disabled>
                                <i class="fas fa-coffee"></i>
                                <span>Tea Break</span>
                            </button>
                            <button class="action-btn btn-lunch" onclick="markAttendance('LUNCH_BREAK')" id="btnLunch" disabled>
                                <i class="fas fa-utensils"></i>
                                <span>Lunch Break</span>
                            </button>
                            <button class="action-btn btn-work" onclick="markAttendance('WORKING')" id="btnWork" disabled>
                                <i class="fas fa-desktop"></i>
                                <span>Working</span>
                            </button>
                            <button class="action-btn btn-break-end" onclick="markAttendance('BREAK_END')" id="btnBreakEnd" disabled>
                                <i class="fas fa-play-circle"></i>
                                <span>End Break</span>
                            </button>
                        </div>

                        <div style="background: var(--light-blue); padding: 20px; border-radius: 10px; margin-top: 25px;">
                            <h4><i class="fas fa-chart-bar"></i> Today's Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: var(--primary-blue);" id="loginTimeDisplay">--:--</div>
                                    <div style="color: var(--dark-gray); font-size: 12px;">Login Time</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: var(--green);" id="workingHoursDisplay">0h 0m</div>
                                    <div style="color: var(--dark-gray); font-size: 12px;">Working</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: var(--orange);" id="breakTimeDisplay">0h 0m</div>
                                    <div style="color: var(--dark-gray); font-size: 12px;">Break</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Display -->
                <div class="daily-display" style="margin-top: 30px;">
                    <div class="daily-header">
                        <h3><i class="fas fa-users"></i> Today's Attendance - All Staff</h3>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span><i class="fas fa-circle" style="color: var(--green);"></i> Present: <span id="presentCount">0</span></span>
                            <span><i class="fas fa-circle" style="color: var(--red);"></i> Absent: <span id="absentCount">0</span></span>
                            <span><i class="fas fa-circle" style="color: var(--yellow);"></i> Late: <span id="lateCount">0</span></span>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>Staff Name</th>
                                    <th>Status</th>
                                    <th>Login Time</th>
                                    <th>Total Hours</th>
                                    <th>Breaks</th>
                                    <th>Current Activity</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody id="dailyAttendanceTable">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" style="display: none;">
                <!-- Admin Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="overview">Dashboard</button>
                    <button class="tab" data-tab="reports">Reports</button>
                    <button class="tab" data-tab="staff">Staff Management</button>
                    <button class="tab" data-tab="export">Data Export</button>
                </div>

                <!-- Overview Tab -->
                <div class="tab-content active" id="overviewTab">
                    <div class="admin-panel">
                        <h2><i class="fas fa-user-shield"></i> Admin Control Panel</h2>
                        
                        <div class="admin-controls">
                            <button class="admin-btn export" onclick="exportTodayExcel()">
                                <i class="fas fa-file-excel"></i> Export Today
                            </button>
                            <button class="admin-btn report" onclick="showReportModal()">
                                <i class="fas fa-chart-bar"></i> Generate Report
                            </button>
                            <button class="admin-btn reset" onclick="resetTodayData()">
                                <i class="fas fa-trash"></i> Reset Today
                            </button>
                            <button class="admin-btn manage" onclick="switchTab('staff')">
                                <i class="fas fa-users-cog"></i> Manage Staff
                            </button>
                        </div>

                        <!-- Stats -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h4>Total Staff</h4>
                                <div class="stat-value" id="totalStaffCount">0</div>
                                <p>Registered employees</p>
                            </div>
                            <div class="stat-card">
                                <h4>Present Today</h4>
                                <div class="stat-value" id="adminPresentCount">0</div>
                                <p>Currently in office</p>
                            </div>
                            <div class="stat-card">
                                <h4>Late Today</h4>
                                <div class="stat-value" id="adminLateCount">0</div>
                                <p>Arrived after 10:30</p>
                            </div>
                            <div class="stat-card">
                                <h4>Total Fines</h4>
                                <div class="stat-value" id="totalFinesCount">0 AED</div>
                                <p>Late fines today</p>
                            </div>
                        </div>

                        <!-- Today's Detailed View -->
                        <div class="attendance-table" style="margin-top: 30px;">
                            <div class="table-header">
                                <h3><i class="fas fa-clock"></i> Today's Detailed Attendance</h3>
                                <button onclick="refreshAdminView()" style="background: var(--primary-blue); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Photo</th>
                                            <th>Staff ID</th>
                                            <th>Name</th>
                                            <th>Department</th>
                                            <th>Login Time</th>
                                            <th>Current Status</th>
                                            <th>Total Hours</th>
                                            <th>Break Time</th>
                                            <th>Late</th>
                                            <th>Fine</th>
                                            <th>Activities</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminDetailedTable">
                                        <!-- Detailed data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-content" id="reportsTab">
                    <div class="admin-panel">
                        <h2><i class="fas fa-file-alt"></i> Attendance Reports</h2>
                        
                        <div class="report-section">
                            <h3><i class="fas fa-filter"></i> Generate Custom Report</h3>
                            
                            <div class="report-filters">
                                <div class="filter-group">
                                    <label>Report Type</label>
                                    <select id="reportType">
                                        <option value="daily">Daily Report</option>
                                        <option value="weekly">Weekly Report</option>
                                        <option value="monthly">Monthly Report</option>
                                        <option value="custom">Custom Period</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label>Start Date</label>
                                    <input type="date" id="reportStartDate">
                                </div>
                                
                                <div class="filter-group">
                                    <label>End Date</label>
                                    <input type="date" id="reportEndDate">
                                </div>
                                
                                <div class="filter-group">
                                    <label>Staff Member</label>
                                    <select id="reportStaff">
                                        <option value="all">All Staff</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="generateReport()" style="flex: 1; background: var(--primary-blue); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-chart-bar"></i> Generate Report
                                </button>
                                <button onclick="exportReportExcel()" style="flex: 1; background: var(--green); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-file-excel"></i> Export to Excel
                                </button>
                            </div>
                        </div>

                        <!-- Report Results -->
                        <div class="attendance-table" style="margin-top: 30px;">
                            <div class="table-header">
                                <h3><i class="fas fa-list"></i> Report Results</h3>
                                <span id="reportSummary">No report generated yet</span>
                            </div>
                            
                            <div class="table-responsive">
                                <table id="reportResultsTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Staff ID</th>
                                            <th>Name</th>
                                            <th>Login Time</th>
                                            <th>Logout Time</th>
                                            <th>Total Hours</th>
                                            <th>Break Time</th>
                                            <th>Break Count</th>
                                            <th>Status</th>
                                            <th>Late</th>
                                            <th>Fine</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportResultsBody">
                                        <!-- Report results will be shown here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Management Tab -->
                <div class="tab-content" id="staffTab">
                    <div class="admin-panel">
                        <h2><i class="fas fa-users-cog"></i> Staff Management</h2>
                        
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Photo</th>
                                        <th>Staff ID</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Password</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="staffManagementTable">
                                    <!-- Staff management rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <button onclick="addNewStaff()" style="margin-top: 20px; background: var(--green); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Add New Staff
                        </button>
                    </div>
                </div>

                <!-- Export Tab -->
                <div class="tab-content" id="exportTab">
                    <div class="admin-panel">
                        <h2><i class="fas fa-database"></i> Data Export</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                            <div style="background: var(--light-blue); padding: 25px; border-radius: var(--border-radius); text-align: center;">
                                <i class="fas fa-file-excel" style="font-size: 48px; color: var(--green); margin-bottom: 15px;"></i>
                                <h3>Export Today's Data</h3>
                                <p>Download today's attendance in Excel format</p>
                                <button onclick="exportTodayExcel()" style="margin-top: 15px; background: var(--green); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">
                                    <i class="fas fa-download"></i> Export Today
                                </button>
                            </div>
                            
                            <div style="background: var(--light-blue); padding: 25px; border-radius: var(--border-radius); text-align: center;">
                                <i class="fas fa-calendar-alt" style="font-size: 48px; color: var(--blue); margin-bottom: 15px;"></i>
                                <h3>Export Monthly Data</h3>
                                <p>Download complete month data in Excel</p>
                                <div style="margin-top: 15px;">
                                    <input type="month" id="exportMonth" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 5px;">
                                    <button onclick="exportMonthlyExcel()" style="background: var(--primary-blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">
                                        <i class="fas fa-download"></i> Export Month
                                    </button>
                                </div>
                            </div>
                            
                            <div style="background: var(--light-blue); padding: 25px; border-radius: var(--border-radius); text-align: center;">
                                <i class="fas fa-file-archive" style="font-size: 48px; color: var(--orange); margin-bottom: 15px;"></i>
                                <h3>Backup All Data</h3>
                                <p>Create a complete backup of all data</p>
                                <button onclick="exportAllData()" style="margin-top: 15px; background: var(--orange); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">
                                    <i class="fas fa-save"></i> Backup All Data
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: var(--border-radius);">
                            <h3><i class="fas fa-info-circle"></i> Export Information</h3>
                            <p style="margin-top: 10px; color: var(--dark-gray);">
                                Exported Excel files will contain: Staff details, login/logout times, break times, total working hours, late arrivals, fines, and all activities.
                            </p>
                            <p style="margin-top: 5px; color: var(--dark-gray);">
                                Files are formatted with proper columns, formulas for calculations, and can be opened in Microsoft Excel, Google Sheets, or any spreadsheet software.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Universal Expert HR Attendance System &copy; 2024 | Complete Solution with Excel Export</p>
            <p style="margin-top: 5px; font-size: 12px;">Data stored securely | Excel export functionality | Photo upload support</p>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Attendance marked successfully!</span>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-bar"></i> Generate Report</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 20px; color: var(--dark-gray); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="report-filters">
                <div class="filter-group">
                    <label>Report Period</label>
                    <select id="modalReportType">
                        <option value="daily">Daily Report</option>
                        <option value="weekly">Weekly Report (Last 7 days)</option>
                        <option value="monthly">Monthly Report (Current Month)</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>From Date</label>
                    <input type="date" id="modalStartDate">
                </div>
                
                <div class="filter-group">
                    <label>To Date</label>
                    <input type="date" id="modalEndDate">
                </div>
                
                <div class="filter-group">
                    <label>Staff</label>
                    <select id="modalReportStaff">
                        <option value="all">All Staff</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button onclick="generateModalReport()" style="flex: 1; background: var(--primary-blue); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-chart-bar"></i> Generate
                </button>
                <button onclick="exportModalReport()" style="flex: 1; background: var(--green); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button onclick="closeModal()" style="flex: 1; background: var(--gray); color: var(--dark-gray); border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div class="modal" id="staffModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add/Edit Staff</h3>
                <button onclick="closeStaffModal()" style="background: none; border: none; font-size: 20px; color: var(--dark-gray); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="display: flex; gap: 30px; margin-bottom: 25px;">
                <!-- Photo Upload -->
                <div style="flex-shrink: 0;">
                    <div class="photo-upload">
                        <div class="staff-avatar" style="width: 150px; height: 150px;">
                            <img id="modalStaffPhoto" src="" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="initials" id="modalStaffInitials" style="width: 150px; height: 150px; font-size: 48px;">A</div>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" onchange="previewStaffPhoto(event)">
                        <label for="photoInput">
                            <i class="fas fa-camera"></i>
                        </label>
                    </div>
                    <p style="text-align: center; margin-top: 10px; font-size: 12px; color: var(--dark-gray);">
                        Click camera icon to upload photo
                    </p>
                </div>
                
                <!-- Staff Details -->
                <div style="flex: 1;">
                    <div class="form-group">
                        <label>Staff ID</label>
                        <input type="text" id="modalStaffId" placeholder="e.g., karan123">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="modalStaffName" placeholder="e.g., Karan Sharma">
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <select id="modalStaffDept">
                            <option value="Management">Management</option>
                            <option value="Development">Development</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="HR">Human Resources</option>
                            <option value="Support">Support</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="modalStaffPassword" placeholder="Enter password">
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveStaff()" style="flex: 1; background: var(--primary-blue); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    Save Staff
                </button>
                <button onclick="closeStaffModal()" style="flex: 1; background: var(--gray); color: var(--dark-gray); border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // DATABASE & CONFIGURATION
        // ==============================================
        const DATABASE = {
            name: 'hr_attendance_complete',
            version: '3.0',
            storageKey: 'hr_attendance_complete_v3'
        };

        const CONFIG = {
            LATE_THRESHOLD: "10:30",
            FINE_AMOUNT: 25,
            OFFICE_HOURS: {
                start: "09:00",
                end: "18:00"
            }
        };

        // ==============================================
        // GLOBAL VARIABLES
        // ==============================================
        let currentUser = null;
        let isAdmin = false;
        let allStaffData = {};
        let attendanceData = {};
        let editingStaffId = null;

        // ==============================================
        // INITIALIZATION
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing Complete HR System...");
            loadDatabase();
            setTodayDate();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            setupTabListeners();
        });

        function loadDatabase() {
            const savedData = localStorage.getItem(DATABASE.storageKey);
            
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                allStaffData = parsedData.allStaffData || {};
                attendanceData = parsedData.attendanceData || {};
                console.log("Database loaded from storage");
            } else {
                initializeDefaultStaff();
                console.log("New database initialized");
            }
            
            // Initialize today's date in attendance data
            const today = getTodayString();
            if (!attendanceData[today]) {
                attendanceData[today] = {};
            }
            
            saveDatabase();
        }

        function initializeDefaultStaff() {
            const defaultStaff = [
                { id: "karan123", name: "Karan Sharma", password: "karan123", department: "Management", color: "#3498db" },
                { id: "farid456", name: "Farid Ahmed", password: "farid456", department: "Development", color: "#2ecc71" },
                { id: "magda789", name: "Magda Kowalski", password: "magda789", department: "Marketing", color: "#e74c3c" },
                { id: "subhash001", name: "Subhash Patel", password: "subhash001", department: "Operations", color: "#f39c12" },
                { id: "sanju002", name: "Sanju Verma", password: "sanju002", department: "Sales", color: "#9b59b6" },
                { id: "aliza003", name: "Aliza Khan", password: "aliza003", department: "HR", color: "#1abc9c" },
                { id: "bibek004", name: "Bibek Thapa", password: "bibek004", department: "Support", color: "#34495e" }
            ];

            defaultStaff.forEach(staff => {
                allStaffData[staff.id] = {
                    ...staff,
                    photo: null,
                    status: "offline",
                    loginTime: null,
                    logoutTime: null,
                    totalHours: 0,
                    breakTime: 0,
                    breakStart: null,
                    activities: [],
                    late: false,
                    fine: 0,
                    lastActivity: null
                };
            });

            attendanceData = {};
        }

        function saveDatabase() {
            const dataToSave = {
                allStaffData: allStaffData,
                attendanceData: attendanceData,
                lastSaved: new Date().toISOString(),
                version: DATABASE.version
            };
            
            localStorage.setItem(DATABASE.storageKey, JSON.stringify(dataToSave));
            console.log("Database saved");
        }

        // ==============================================
        // LOGIN SYSTEM
        // ==============================================
        function showLoginForm(type) {
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (type === 'staff') {
                document.getElementById('staffLoginForm').classList.add('active');
                document.querySelectorAll('.login-tab')[0].classList.add('active');
            } else {
                document.getElementById('adminLoginForm').classList.add('active');
                document.querySelectorAll('.login-tab')[1].classList.add('active');
            }
            
            document.getElementById('loginError').style.display = 'none';
        }

        function staffLogin() {
            const username = document.getElementById('staffUsername').value.trim();
            const password = document.getElementById('staffPassword').value.trim();
            
            const staff = allStaffData[username];
            
            if (staff && staff.password === password) {
                currentUser = staff;
                isAdmin = false;
                showMainApp();
                setupStaffDashboard();
                updateDailyDisplay();
                showToast(`Welcome ${staff.name}!`, 'success');
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function adminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (username === "admin" && password === "admin123") {
                currentUser = { name: "System Admin", id: "admin", isAdmin: true };
                isAdmin = true;
                showMainApp();
                setupAdminDashboard();
                updateDailyDisplay();
                showToast("Welcome Admin!", 'success');
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            const welcomeMsg = isAdmin ? 
                `Admin: ${currentUser.name}` : 
                `Staff: ${currentUser.name} (${currentUser.department})`;
            
            document.getElementById('welcomeMessage').textContent = welcomeMsg;
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('staffUsername').value = '';
            document.getElementById('staffPassword').value = '';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
            
            showLoginForm('staff');
        }

        // ==============================================
        // STAFF DASHBOARD
        // ==============================================
        function setupStaffDashboard() {
            document.getElementById('staffDashboard').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            
            // Update staff info
            updateStaffInfo();
            
            // Load today's activities
            loadTodayActivities();
            
            // Update button states
            updateButtonStates();
            
            // Auto-refresh display
            setInterval(updateDailyDisplay, 30000);
        }

        function updateStaffInfo() {
            document.getElementById('staffName').textContent = currentUser.name;
            document.getElementById('staffId').textContent = currentUser.id;
            document.getElementById('staffDept').textContent = currentUser.department;
            document.getElementById('staffInitials').textContent = currentUser.name.charAt(0);
            document.getElementById('staffInitials').style.background = currentUser.color;
            
            // Load staff photo
            if (currentUser.photo) {
                document.getElementById('staffPhoto').src = currentUser.photo;
                document.getElementById('staffPhoto').style.display = 'block';
                document.getElementById('staffInitials').style.display = 'none';
            } else {
                document.getElementById('staffPhoto').style.display = 'none';
                document.getElementById('staffInitials').style.display = 'flex';
            }
        }

        function markAttendance(action) {
            const today = getTodayString();
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Initialize today's record
            if (!attendanceData[today]) attendanceData[today] = {};
            if (!attendanceData[today][currentUser.id]) {
                attendanceData[today][currentUser.id] = {
                    staffId: currentUser.id,
                    staffName: currentUser.name,
                    department: currentUser.department,
                    date: today,
                    loginTime: null,
                    logoutTime: null,
                    status: "offline",
                    activities: [],
                    totalHours: 0,
                    breakTime: 0,
                    breakStart: null,
                    late: false,
                    fine: 0,
                    currentActivity: "Not checked in"
                };
            }
            
            const record = attendanceData[today][currentUser.id];
            const activity = {
                action: action,
                time: now,
                timestamp: timeString,
                datetime: now.toISOString()
            };
            
            // Handle different actions
            switch(action) {
                case 'LOGIN':
                    record.loginTime = now;
                    record.status = "working";
                    record.currentActivity = "Working";
                    record.late = checkIfLate(now);
                    if (record.late) {
                        record.fine = CONFIG.FINE_AMOUNT;
                        activity.message = "Late arrival - 25 AED fine applied";
                    }
                    break;
                    
                case 'LOGOUT':
                    record.logoutTime = now;
                    record.status = "offline";
                    record.currentActivity = "Logged out";
                    // Calculate total hours
                    if (record.loginTime) {
                        const totalMs = now - record.loginTime;
                        const breakMs = (record.breakTime || 0) * 60 * 1000;
                        record.totalHours = (totalMs - breakMs) / (1000 * 60 * 60);
                    }
                    break;
                    
                case 'TEA_BREAK':
                case 'LUNCH_BREAK':
                    record.status = "break";
                    record.breakStart = now;
                    record.currentActivity = action === 'TEA_BREAK' ? "Tea Break" : "Lunch Break";
                    break;
                    
                case 'BREAK_END':
                    if (record.breakStart) {
                        const breakDuration = (now - record.breakStart) / (1000 * 60); // minutes
                        record.breakTime = (record.breakTime || 0) + breakDuration;
                        record.breakStart = null;
                    }
                    record.status = "working";
                    record.currentActivity = "Working";
                    break;
                    
                case 'WORKING':
                    record.status = "working";
                    record.currentActivity = "Working";
                    break;
            }
            
            // Add activity to record
            record.activities.push(activity);
            
            // Update global staff data
            allStaffData[currentUser.id].status = record.status;
            allStaffData[currentUser.id].lastActivity = `${action} at ${timeString}`;
            
            // Save and update UI
            saveDatabase();
            updateStaffDisplay(record);
            updateTimeline(record.activities);
            updateButtonStates();
            updateDailyDisplay();
            
            // Show toast
            let message = `${action.replace('_', ' ')} marked at ${timeString}`;
            if (record.late && action === 'LOGIN') {
                message += "  Late arrival - 25 AED fine";
            }
            showToast(message, 'success');
        }

        function updateStaffDisplay(record) {
            let statusText = "";
            let statusColor = "";
            
            switch(record.status) {
                case "working":
                    statusText = "Working";
                    statusColor = "var(--green)";
                    break;
                case "break":
                    statusText = record.currentActivity || "On Break";
                    statusColor = "var(--orange)";
                    break;
                case "offline":
                    statusText = record.logoutTime ? "Logged Out" : "Not Checked In";
                    statusColor = record.logoutTime ? "var(--red)" : "var(--dark-gray)";
                    break;
            }
            
            document.getElementById('currentStatusText').textContent = statusText;
            document.getElementById('currentStatusText').style.color = statusColor;
            
            // Update time displays
            if (record.loginTime) {
                const loginTime = new Date(record.loginTime);
                document.getElementById('loginTimeDisplay').textContent = 
                    loginTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const totalHours = record.totalHours || 0;
                const hours = Math.floor(totalHours);
                const minutes = Math.round((totalHours % 1) * 60);
                document.getElementById('workingHoursDisplay').textContent = `${hours}h ${minutes}m`;
                
                const breakHours = (record.breakTime || 0) / 60;
                const breakH = Math.floor(breakHours);
                const breakM = Math.round((breakHours % 1) * 60);
                document.getElementById('breakTimeDisplay').textContent = `${breakH}h ${breakM}m`;
            }
        }

        function loadTodayActivities() {
            const today = getTodayString();
            const record = attendanceData[today]?.[currentUser.id];
            
            if (record) {
                updateStaffDisplay(record);
                updateTimeline(record.activities);
            }
        }

        function updateTimeline(activities) {
            const timeline = document.getElementById('todayTimeline');
            timeline.innerHTML = '';
            
            if (!activities || activities.length === 0) {
                timeline.innerHTML = '<p style="text-align: center; color: var(--dark-gray); padding: 20px;">No activities yet</p>';
                return;
            }
            
            activities.slice(-5).reverse().forEach(activity => {
                const time = new Date(activity.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const actionText = activity.action.replace('_', ' ');
                
                let statusClass = '';
                switch(activity.action) {
                    case 'LOGIN': statusClass = 'status-login'; break;
                    case 'LOGOUT': statusClass = 'status-logout'; break;
                    case 'TEA_BREAK':
                    case 'LUNCH_BREAK': statusClass = 'status-break'; break;
                    default: statusClass = 'status-work';
                }
                
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    <div class="timeline-time">${time}</div>
                    <div class="timeline-activity">${actionText}</div>
                    <div class="timeline-status ${statusClass}">${actionText}</div>
                `;
                timeline.appendChild(item);
            });
        }

        function updateButtonStates() {
            const today = getTodayString();
            const record = attendanceData[today]?.[currentUser.id];
            const isLoggedIn = record && record.loginTime && !record.logoutTime;
            const isOnBreak = record && record.status === "break";
            
            document.getElementById('btnLogin').disabled = isLoggedIn;
            document.getElementById('btnLogout').disabled = !isLoggedIn;
            document.getElementById('btnTea').disabled = !isLoggedIn || isOnBreak;
            document.getElementById('btnLunch').disabled = !isLoggedIn || isOnBreak;
            document.getElementById('btnWork').disabled = !isLoggedIn;
            document.getElementById('btnBreakEnd').disabled = !isOnBreak;
        }

        // ==============================================
        // DAILY DISPLAY
        // ==============================================
        function updateDailyDisplay() {
            const today = getTodayString();
            const todayRecords = attendanceData[today] || {};
            const tableBody = document.getElementById('dailyAttendanceTable');
            
            let html = '';
            let presentCount = 0;
            let absentCount = Object.keys(allStaffData).length;
            let lateCount = 0;
            let totalFines = 0;
            
            // Create rows for all staff
            Object.values(allStaffData).forEach(staff => {
                const record = todayRecords[staff.id];
                const isPresent = record && record.loginTime && !record.logoutTime;
                const isLate = record && record.late;
                
                if (isPresent) {
                    presentCount++;
                    absentCount--;
                }
                if (isLate) {
                    lateCount++;
                    totalFines += record.fine || 0;
                }
                
                // Get staff photo or initials
                let photoHtml = '';
                if (staff.photo) {
                    photoHtml = `<img src="${staff.photo}" alt="${staff.name}" class="staff-photo-small">`;
                } else {
                    const initials = staff.name.split(' ').map(n => n[0]).join('').substring(0, 2);
                    photoHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: ${staff.color}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${initials}</div>`;
                }
                
                // Calculate time info
                let loginTime = '--';
                let totalHours = '--';
                let breaks = '0';
                let currentActivity = record?.currentActivity || 'Not checked in';
                let lastUpdated = '--';
                
                if (record) {
                    if (record.loginTime) {
                        loginTime = new Date(record.loginTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                    
                    if (record.totalHours > 0) {
                        const hours = Math.floor(record.totalHours);
                        const minutes = Math.round((record.totalHours % 1) * 60);
                        totalHours = `${hours}h ${minutes}m`;
                    }
                    
                    // Count breaks
                    if (record.activities) {
                        breaks = record.activities.filter(a => 
                            a.action === 'TEA_BREAK' || a.action === 'LUNCH_BREAK'
                        ).length;
                    }
                    
                    if (record.activities && record.activities.length > 0) {
                        const lastActivity = record.activities[record.activities.length - 1];
                        lastUpdated = new Date(lastActivity.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                }
                
                // Status badge
                let statusBadge = '';
                if (isPresent) {
                    statusBadge = `<span class="badge badge-present">Present</span>`;
                    if (isLate) {
                        statusBadge += ` <span class="badge badge-late">Late</span>`;
                    }
                    if (record?.status === 'break') {
                        statusBadge = `<span class="badge badge-break">On Break</span>`;
                    }
                } else if (record?.logoutTime) {
                    statusBadge = `<span class="badge badge-absent">Logged Out</span>`;
                } else {
                    statusBadge = `<span class="badge badge-absent">Not in</span>`;
                }
                
                html += `
                    <tr>
                        <td class="staff-photo-cell">${photoHtml}</td>
                        <td><strong>${staff.name}</strong><br><small>${staff.department}</small></td>
                        <td>${statusBadge}</td>
                        <td>${loginTime}</td>
                        <td>${totalHours}</td>
                        <td>${breaks}</td>
                        <td>${currentActivity}</td>
                        <td>${lastUpdated}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            // Update counters
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('lateCount').textContent = lateCount;
            
            // Update admin dashboard if visible
            if (isAdmin) {
                document.getElementById('adminPresentCount').textContent = presentCount;
                document.getElementById('adminLateCount').textContent = lateCount;
                document.getElementById('totalFinesCount').textContent = totalFines + ' AED';
                document.getElementById('totalStaffCount').textContent = Object.keys(allStaffData).length;
                updateAdminDetailedTable();
            }
        }

        // ==============================================
        // ADMIN DASHBOARD
        // ==============================================
        function setupAdminDashboard() {
            document.getElementById('staffDashboard').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            
            updateDailyDisplay();
            populateStaffDropdowns();
            updateStaffManagementTable();
            
            // Set default dates
            const today = new Date();
            document.getElementById('reportStartDate').value = getTodayString();
            document.getElementById('reportEndDate').value = getTodayString();
            document.getElementById('exportMonth').value = today.toISOString().substring(0, 7);
            
            // Auto-refresh
            setInterval(updateDailyDisplay, 30000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabName + 'Tab') {
                    content.classList.add('active');
                }
            });
        }

        function setupTabListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
        }

        function refreshAdminView() {
            updateDailyDisplay();
            showToast('Admin view refreshed', 'success');
        }

        function updateAdminDetailedTable() {
            const today = getTodayString();
            const todayRecords = attendanceData[today] || {};
            const tableBody = document.getElementById('adminDetailedTable');
            
            let html = '';
            
            Object.values(allStaffData).forEach(staff => {
                const record = todayRecords[staff.id];
                
                // Get staff photo or initials
                let photoHtml = '';
                if (staff.photo) {
                    photoHtml = `<img src="${staff.photo}" alt="${staff.name}" class="staff-photo-small">`;
                } else {
                    const initials = staff.name.split(' ').map(n => n[0]).join('').substring(0, 2);
                    photoHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: ${staff.color}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${initials}</div>`;
                }
                
                // Calculate values
                const loginTime = record?.loginTime ? 
                    new Date(record.loginTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--';
                
                let statusBadge = '';
                if (record) {
                    if (record.status === 'working') statusBadge = '<span class="badge badge-present">Working</span>';
                    else if (record.status === 'break') statusBadge = '<span class="badge badge-break">On Break</span>';
                    else if (record.logoutTime) statusBadge = '<span class="badge badge-absent">Logged Out</span>';
                    else statusBadge = '<span class="badge badge-absent">Absent</span>';
                    
                    if (record.late) statusBadge += ' <span class="badge badge-late">Late</span>';
                } else {
                    statusBadge = '<span class="badge badge-absent">Absent</span>';
                }
                
                const totalHours = record?.totalHours ? 
                    `${Math.floor(record.totalHours)}h ${Math.round((record.totalHours % 1) * 60)}m` : '--';
                
                const breakTime = record?.breakTime ? 
                    `${Math.floor(record.breakTime/60)}h ${Math.round(record.breakTime % 60)}m` : '0m';
                
                const lateStatus = record?.late ? 'Yes' : 'No';
                const fineAmount = record?.fine ? `${record.fine} AED` : '-';
                
                const activities = record?.activities ? 
                    record.activities.map(a => `${a.action.replace('_', ' ')} (${new Date(a.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})})`).join(', ') : 'None';
                
                html += `
                    <tr>
                        <td class="staff-photo-cell">${photoHtml}</td>
                        <td>${staff.id}</td>
                        <td>${staff.name}</td>
                        <td>${staff.department}</td>
                        <td>${loginTime}</td>
                        <td>${statusBadge}</td>
                        <td>${totalHours}</td>
                        <td>${breakTime}</td>
                        <td>${lateStatus}</td>
                        <td>${fineAmount}</td>
                        <td title="${activities}" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${activities.substring(0, 30)}${activities.length > 30 ? '...' : ''}
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // ==============================================
        // EXPORT FUNCTIONS (Excel Format)
        // ==============================================
        function exportTodayExcel() {
            const today = getTodayString();
            const todayRecords = attendanceData[today] || {};
            
            // Prepare data for Excel
            const excelData = [];
            
            // Add header
            excelData.push([
                'DATE', 'STAFF ID', 'STAFF NAME', 'DEPARTMENT', 
                'LOGIN TIME', 'LOGOUT TIME', 'STATUS', 
                'TOTAL WORKING HOURS', 'BREAK TIME', 'BREAK COUNT',
                'LATE ARRIVAL', 'FINE AMOUNT', 'ACTIVITIES'
            ]);
            
            // Add data rows
            Object.values(allStaffData).forEach(staff => {
                const record = todayRecords[staff.id];
                
                const loginTime = record?.loginTime ? 
                    new Date(record.loginTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--';
                
                const logoutTime = record?.logoutTime ? 
                    new Date(record.logoutTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--';
                
                let status = 'Absent';
                if (record) {
                    if (record.status === 'working') status = 'Working';
                    else if (record.status === 'break') status = 'On Break';
                    else if (record.logoutTime) status = 'Logged Out';
                }
                
                const totalHours = record?.totalHours ? record.totalHours.toFixed(2) + ' hours' : '--';
                const breakTime = record?.breakTime ? 
                    `${Math.floor(record.breakTime/60)}h ${Math.round(record.breakTime % 60)}m` : '0m';
                
                const breakCount = record?.activities ? 
                    record.activities.filter(a => a.action.includes('BREAK')).length : 0;
                
                const lateArrival = record?.late ? 'Yes' : 'No';
                const fineAmount = record?.fine ? `${record.fine} AED` : '-';
                
                const activities = record?.activities ? 
                    record.activities.map(a => 
                        `${a.action.replace('_', ' ')} (${new Date(a.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})})`
                    ).join('; ') : 'None';
                
                excelData.push([
                    today,
                    staff.id,
                    staff.name,
                    staff.department,
                    loginTime,
                    logoutTime,
                    status,
                    totalHours,
                    breakTime,
                    breakCount,
                    lateArrival,
                    fineAmount,
                    activities
                ]);
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Set column widths
            const wscols = [
                {wch: 12}, // DATE
                {wch: 12}, // STAFF ID
                {wch: 20}, // STAFF NAME
                {wch: 15}, // DEPARTMENT
                {wch: 12}, // LOGIN TIME
                {wch: 12}, // LOGOUT TIME
                {wch: 15}, // STATUS
                {wch: 18}, // TOTAL HOURS
                {wch: 12}, // BREAK TIME
                {wch: 12}, // BREAK COUNT
                {wch: 12}, // LATE ARRIVAL
                {wch: 15}, // FINE AMOUNT
                {wch: 50}  // ACTIVITIES
            ];
            ws['!cols'] = wscols;
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Today's Attendance");
            
            // Add summary sheet
            addSummarySheet(wb, today);
            
            // Generate Excel file
            const fileName = `attendance_${today}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast(`Today's data exported to ${fileName}`, 'success');
        }

        function addSummarySheet(wb, date) {
            const todayRecords = attendanceData[date] || {};
            
            // Calculate summary
            const totalStaff = Object.keys(allStaffData).length;
            const presentCount = Object.values(todayRecords).filter(r => r.loginTime && !r.logoutTime).length;
            const absentCount = totalStaff - presentCount;
            const lateCount = Object.values(todayRecords).filter(r => r.late).length;
            const totalFines = Object.values(todayRecords).reduce((sum, r) => sum + (r.fine || 0), 0);
            
            const summaryData = [
                ['ATTENDANCE SUMMARY', ''],
                ['Report Date', date],
                ['Total Staff', totalStaff],
                ['Present Today', presentCount],
                ['Absent Today', absentCount],
                ['Late Arrivals', lateCount],
                ['Total Fines', `${totalFines} AED`],
                ['', ''],
                ['LATE ARRIVAL POLICY', ''],
                ['Late Threshold', '10:30 AM'],
                ['Fine Amount', '25 AED per late arrival'],
                ['', ''],
                ['Report Generated', new Date().toLocaleString()]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws, "Summary");
        }

        function exportMonthlyExcel() {
            const month = document.getElementById('exportMonth').value;
            if (!month) {
                showToast('Please select a month', 'error');
                return;
            }
            
            // Filter records for the selected month
            const monthRecords = [];
            Object.keys(attendanceData).forEach(date => {
                if (date.startsWith(month)) {
                    Object.values(attendanceData[date]).forEach(record => {
                        monthRecords.push({
                            ...record,
                            date: date
                        });
                    });
                }
            });
            
            if (monthRecords.length === 0) {
                showToast('No data found for selected month', 'warning');
                return;
            }
            
            // Prepare Excel data
            const excelData = [
                ['DATE', 'STAFF ID', 'STAFF NAME', 'DEPARTMENT', 'LOGIN TIME', 'LOGOUT TIME', 
                 'TOTAL HOURS', 'BREAK TIME', 'BREAK COUNT', 'LATE', 'FINE', 'STATUS']
            ];
            
            monthRecords.forEach(record => {
                const loginTime = record.loginTime ? 
                    new Date(record.loginTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--';
                
                const logoutTime = record.logoutTime ? 
                    new Date(record.logoutTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--';
                
                const totalHours = record.totalHours ? record.totalHours.toFixed(2) + ' hours' : '--';
                const breakTime = record.breakTime ? 
                    `${Math.floor(record.breakTime/60)}h ${Math.round(record.breakTime % 60)}m` : '0m';
                
                const breakCount = record.activities ? 
                    record.activities.filter(a => a.action.includes('BREAK')).length : 0;
                
                const late = record.late ? 'Yes' : 'No';
                const fine = record.fine ? `${record.fine} AED` : '-';
                
                let status = 'Absent';
                if (record.loginTime && !record.logoutTime) status = 'Present';
                if (record.logoutTime) status = 'Logged Out';
                
                excelData.push([
                    record.date,
                    record.staffId,
                    record.staffName,
                    record.department,
                    loginTime,
                    logoutTime,
                    totalHours,
                    breakTime,
                    breakCount,
                    late,
                    fine,
                    status
                ]);
            });
            
            // Create workbook
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Attendance ${month}`);
            
            // Add monthly summary
            addMonthlySummary(wb, month, monthRecords);
            
            // Export
            const fileName = `attendance_monthly_${month}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast(`Monthly data exported to ${fileName}`, 'success');
        }

        function addMonthlySummary(wb, month, records) {
            const staffMap = {};
            records.forEach(record => {
                if (!staffMap[record.staffId]) {
                    staffMap[record.staffId] = {
                        name: record.staffName,
                        presentDays: 0,
                        lateDays: 0,
                        totalHours: 0,
                        totalFines: 0
                    };
                }
                
                if (record.loginTime) {
                    staffMap[record.staffId].presentDays++;
                    staffMap[record.staffId].totalHours += record.totalHours || 0;
                }
                if (record.late) {
                    staffMap[record.staffId].lateDays++;
                    staffMap[record.staffId].totalFines += record.fine || 0;
                }
            });
            
            const summaryData = [
                ['MONTHLY ATTENDANCE SUMMARY', ''],
                ['Month', month],
                ['Total Records', records.length],
                ['', ''],
                ['STAFF PERFORMANCE', '', '', '', ''],
                ['Staff ID', 'Staff Name', 'Present Days', 'Late Days', 'Total Hours', 'Total Fines']
            ];
            
            Object.keys(staffMap).forEach(staffId => {
                const staff = staffMap[staffId];
                summaryData.push([
                    staffId,
                    staff.name,
                    staff.presentDays,
                    staff.lateDays,
                    staff.totalHours.toFixed(1) + ' hours',
                    staff.totalFines + ' AED'
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws, "Monthly Summary");
        }

        function exportAllData() {
            // Create comprehensive backup
            const backupData = {
                allStaffData: allStaffData,
                attendanceData: attendanceData,
                exportDate: new Date().toISOString(),
                config: CONFIG
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            saveAs(blob, `hr_backup_${getTodayString()}.json`);
            
            showToast('Complete backup exported', 'success');
        }

        // ==============================================
        // REPORT GENERATION
        // ==============================================
        function showReportModal() {
            document.getElementById('reportModal').classList.add('active');
            
            // Set default dates
            const today = new Date();
            document.getElementById('modalStartDate').value = getTodayString();
            document.getElementById('modalEndDate').value = getTodayString();
            
            // Populate staff dropdown
            populateModalStaffDropdown();
        }

        function closeModal() {
            document.getElementById('reportModal').classList.remove('active');
        }

        function generateModalReport() {
            const reportType = document.getElementById('modalReportType').value;
            const startDate = document.getElementById('modalStartDate').value;
            const endDate = document.getElementById('modalEndDate').value;
            const staffId = document.getElementById('modalReportStaff').value;
            
            if (!startDate || !endDate) {
                showToast('Please select date range', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showToast('Start date must be before end date', 'error');
                return;
            }
            
            // Generate report
            const reportData = generateReportData(startDate, endDate, staffId);
            displayReportResults(reportData, startDate, endDate);
            
            closeModal();
        }

        function exportModalReport() {
            const reportType = document.getElementById('modalReportType').value;
            const startDate = document.getElementById('modalStartDate').value;
            const endDate = document.getElementById('modalEndDate').value;
            const staffId = document.getElementById('modalReportStaff').value;
            
            if (!startDate || !endDate) {
                showToast('Please select date range', 'error');
                return;
            }
            
            const reportData = generateReportData(startDate, endDate, staffId);
            exportReportToExcel(reportData, startDate, endDate, staffId);
        }

        function generateReportData(startDate, endDate, staffId) {
            const results = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Loop through each date in range
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dateStr = date.toISOString().split('T')[0];
                const dayRecords = attendanceData[dateStr] || {};
                
                if (staffId === 'all') {
                    // All staff
                    Object.values(allStaffData).forEach(staff => {
                        const record = dayRecords[staff.id];
                        if (record || staffId === 'all') {
                            results.push(createReportRow(dateStr, staff, record));
                        }
                    });
                } else {
                    // Specific staff
                    const staff = allStaffData[staffId];
                    if (staff) {
                        const record = dayRecords[staffId];
                        results.push(createReportRow(dateStr, staff, record));
                    }
                }
            }
            
            return results;
        }

        function createReportRow(date, staff, record) {
            const loginTime = record?.loginTime ? 
                new Date(record.loginTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--';
            
            const logoutTime = record?.logoutTime ? 
                new Date(record.logoutTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--';
            
            const totalHours = record?.totalHours ? record.totalHours.toFixed(2) : '0';
            const breakTime = record?.breakTime ? (record.breakTime / 60).toFixed(2) : '0';
            
            const breakCount = record?.activities ? 
                record.activities.filter(a => a.action.includes('BREAK')).length : 0;
            
            let status = 'Absent';
            if (record) {
                if (record.loginTime && !record.logoutTime) status = 'Present';
                if (record.logoutTime) status = 'Logged Out';
                if (record.status === 'break') status = 'On Break';
            }
            
            const late = record?.late ? 'Yes' : 'No';
            const fine = record?.fine || 0;
            
            return {
                date: date,
                staffId: staff.id,
                staffName: staff.name,
                loginTime: loginTime,
                logoutTime: logoutTime,
                totalHours: totalHours,
                breakTime: breakTime,
                breakCount: breakCount,
                status: status,
                late: late,
                fine: fine
            };
        }

        function displayReportResults(reportData, startDate, endDate) {
            const tableBody = document.getElementById('reportResultsBody');
            let html = '';
            
            reportData.forEach(row => {
                html += `
                    <tr>
                        <td>${row.date}</td>
                        <td>${row.staffId}</td>
                        <td>${row.staffName}</td>
                        <td>${row.loginTime}</td>
                        <td>${row.logoutTime}</td>
                        <td>${row.totalHours} hours</td>
                        <td>${row.breakTime} hours</td>
                        <td>${row.breakCount}</td>
                        <td>${row.status}</td>
                        <td>${row.late}</td>
                        <td>${row.fine > 0 ? row.fine + ' AED' : '-'}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html || `
                <tr>
                    <td colspan="11" style="text-align: center; padding: 40px; color: var(--dark-gray);">
                        No data found for the selected period
                    </td>
                </tr>
            `;
            
            // Update summary
            const totalRecords = reportData.length;
            const presentCount = reportData.filter(r => r.status === 'Present').length;
            const lateCount = reportData.filter(r => r.late === 'Yes').length;
            const totalFines = reportData.reduce((sum, r) => sum + r.fine, 0);
            
            document.getElementById('reportSummary').textContent = 
                `${totalRecords} records | ${presentCount} present | ${lateCount} late | ${totalFines} AED fines`;
            
            // Switch to reports tab
            switchTab('reports');
        }

        function exportReportToExcel(reportData, startDate, endDate, staffId) {
            if (reportData.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            // Prepare Excel data
            const excelData = [
                ['ATTENDANCE REPORT', '', '', '', '', '', '', '', '', '', ''],
                ['Report Period', `${startDate} to ${endDate}`, '', '', '', '', '', '', '', '', ''],
                ['Generated', new Date().toLocaleString(), '', '', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', '', '', '', ''],
                ['DATE', 'STAFF ID', 'STAFF NAME', 'LOGIN TIME', 'LOGOUT TIME', 
                 'TOTAL HOURS', 'BREAK TIME', 'BREAK COUNT', 'STATUS', 'LATE', 'FINE']
            ];
            
            let totalFines = 0;
            let totalHours = 0;
            
            reportData.forEach(row => {
                excelData.push([
                    row.date,
                    row.staffId,
                    row.staffName,
                    row.loginTime,
                    row.logoutTime,
                    row.totalHours + ' hours',
                    row.breakTime + ' hours',
                    row.breakCount,
                    row.status,
                    row.late,
                    row.fine > 0 ? row.fine + ' AED' : '-'
                ]);
                
                totalFines += row.fine;
                totalHours += parseFloat(row.totalHours) || 0;
            });
            
            // Add summary
            excelData.push(['', '', '', '', '', '', '', '', '', '', '']);
            excelData.push(['SUMMARY', '', '', '', '', '', '', '', '', '', '']);
            excelData.push(['Total Records', reportData.length, '', '', '', '', '', '', '', '', '']);
            excelData.push(['Total Hours', totalHours.toFixed(2) + ' hours', '', '', '', '', '', '', '', '', '']);
            excelData.push(['Total Fines', totalFines + ' AED', '', '', '', '', '', '', '', '', '']);
            
            // Create workbook
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            
            const fileName = staffId === 'all' ? 
                `report_${startDate}_to_${endDate}.xlsx` : 
                `report_${staffId}_${startDate}_to_${endDate}.xlsx`;
            
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, fileName);
            
            showToast(`Report exported to ${fileName}`, 'success');
        }

        // ==============================================
        // STAFF MANAGEMENT
        // ==============================================
        function updateStaffManagementTable() {
            const tableBody = document.getElementById('staffManagementTable');
            let html = '';
            
            Object.values(allStaffData).forEach(staff => {
                // Get staff photo or initials
                let photoHtml = '';
                if (staff.photo) {
                    photoHtml = `<img src="${staff.photo}" alt="${staff.name}" class="staff-photo-small">`;
                } else {
                    const initials = staff.name.split(' ').map(n => n[0]).join('').substring(0, 2);
                    photoHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: ${staff.color}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${initials}</div>`;
                }
                
                html += `
                    <tr>
                        <td class="staff-photo-cell">${photoHtml}</td>
                        <td>${staff.id}</td>
                        <td>${staff.name}</td>
                        <td>${staff.department}</td>
                        <td>${'*'.repeat(staff.password.length)}</td>
                        <td><span class="badge ${staff.status === 'working' ? 'badge-present' : 'badge-absent'}">${staff.status || 'offline'}</span></td>
                        <td>
                            <button onclick="editStaff('${staff.id}')" style="background: var(--primary-blue); color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 5px; cursor: pointer;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteStaff('${staff.id}')" style="background: var(--red); color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        function addNewStaff() {
            editingStaffId = null;
            document.getElementById('modalStaffId').value = '';
            document.getElementById('modalStaffName').value = '';
            document.getElementById('modalStaffDept').value = 'Management';
            document.getElementById('modalStaffPassword').value = '';
            document.getElementById('modalStaffPhoto').src = '';
            document.getElementById('modalStaffPhoto').style.display = 'none';
            document.getElementById('modalStaffInitials').textContent = 'A';
            document.getElementById('modalStaffInitials').style.display = 'flex';
            document.getElementById('modalStaffInitials').style.background = '#3498db';
            
            document.getElementById('staffModal').classList.add('active');
        }

        function editStaff(staffId) {
            const staff = allStaffData[staffId];
            if (!staff) return;
            
            editingStaffId = staffId;
            document.getElementById('modalStaffId').value = staff.id;
            document.getElementById('modalStaffName').value = staff.name;
            document.getElementById('modalStaffDept').value = staff.department;
            document.getElementById('modalStaffPassword').value = staff.password;
            document.getElementById('modalStaffInitials').textContent = staff.name.charAt(0);
            document.getElementById('modalStaffInitials').style.background = staff.color;
            
            if (staff.photo) {
                document.getElementById('modalStaffPhoto').src = staff.photo;
                document.getElementById('modalStaffPhoto').style.display = 'block';
                document.getElementById('modalStaffInitials').style.display = 'none';
            } else {
                document.getElementById('modalStaffPhoto').style.display = 'none';
                document.getElementById('modalStaffInitials').style.display = 'flex';
            }
            
            document.getElementById('staffModal').classList.add('active');
        }

        function previewStaffPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('modalStaffPhoto').src = e.target.result;
                document.getElementById('modalStaffPhoto').style.display = 'block';
                document.getElementById('modalStaffInitials').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function saveStaff() {
            const staffId = document.getElementById('modalStaffId').value.trim();
            const staffName = document.getElementById('modalStaffName').value.trim();
            const department = document.getElementById('modalStaffDept').value;
            const password = document.getElementById('modalStaffPassword').value.trim();
            const photo = document.getElementById('modalStaffPhoto').src || null;
            
            if (!staffId || !staffName || !password) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            if (editingStaffId === null) {
                // New staff
                if (allStaffData[staffId]) {
                    showToast('Staff ID already exists', 'error');
                    return;
                }
                
                const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];
                const color = colors[Object.keys(allStaffData).length % colors.length];
                
                allStaffData[staffId] = {
                    id: staffId,
                    name: staffName,
                    password: password,
                    department: department,
                    color: color,
                    photo: photo,
                    status: "offline",
                    loginTime: null,
                    logoutTime: null,
                    totalHours: 0,
                    breakTime: 0,
                    activities: [],
                    late: false,
                    fine: 0,
                    lastActivity: null
                };
            } else {
                // Update existing staff
                const staff = allStaffData[editingStaffId];
                staff.id = staffId;
                staff.name = staffName;
                staff.department = department;
                staff.password = password;
                if (photo && photo !== '') {
                    staff.photo = photo;
                }
                
                // If ID changed, update the key
                if (editingStaffId !== staffId) {
                    allStaffData[staffId] = staff;
                    delete allStaffData[editingStaffId];
                    
                    // Update attendance records
                    Object.keys(attendanceData).forEach(date => {
                        if (attendanceData[date][editingStaffId]) {
                            attendanceData[date][staffId] = attendanceData[date][editingStaffId];
                            attendanceData[date][staffId].staffId = staffId;
                            delete attendanceData[date][editingStaffId];
                        }
                    });
                }
            }
            
            saveDatabase();
            updateStaffManagementTable();
            populateStaffDropdowns();
            populateModalStaffDropdown();
            closeStaffModal();
            
            showToast('Staff saved successfully!', 'success');
        }

        function deleteStaff(staffId) {
            if (!confirm(`Are you sure you want to delete staff ${staffId}?`)) {
                return;
            }
            
            delete allStaffData[staffId];
            
            // Remove from attendance data
            Object.keys(attendanceData).forEach(date => {
                if (attendanceData[date][staffId]) {
                    delete attendanceData[date][staffId];
                }
            });
            
            saveDatabase();
            updateStaffManagementTable();
            populateStaffDropdowns();
            populateModalStaffDropdown();
            updateDailyDisplay();
            
            showToast('Staff deleted', 'success');
        }

        function closeStaffModal() {
            document.getElementById('staffModal').classList.remove('active');
            editingStaffId = null;
        }

        function populateStaffDropdowns() {
            let options = '<option value="all">All Staff</option>';
            Object.values(allStaffData).forEach(staff => {
                options += `<option value="${staff.id}">${staff.name} (${staff.department})</option>`;
            });
            
            ['reportStaff'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = options;
            });
        }

        function populateModalStaffDropdown() {
            let options = '<option value="all">All Staff</option>';
            Object.values(allStaffData).forEach(staff => {
                options += `<option value="${staff.id}">${staff.name} (${staff.department})</option>`;
            });
            
            document.getElementById('modalReportStaff').innerHTML = options;
        }

        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function setTodayDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', options);
            
            // Set default dates
            document.getElementById('reportStartDate').value = getTodayString();
            document.getElementById('reportEndDate').value = getTodayString();
            document.getElementById('modalStartDate').value = getTodayString();
            document.getElementById('modalEndDate').value = getTodayString();
        }

        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentDateTime').textContent = `${dateStr} | ${timeStr}`;
        }

        function checkIfLate(time) {
            const lateThreshold = parseTime(CONFIG.LATE_THRESHOLD);
            const currentTime = time.getHours() * 60 + time.getMinutes();
            return currentTime > lateThreshold;
        }

        function parseTime(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            
            const icon = toast.querySelector('i');
            icon.className = type === 'success' ? 'fas fa-check-circle' : 
                            type === 'error' ? 'fas fa-exclamation-circle' : 
                            'fas fa-exclamation-triangle';
            icon.style.color = type === 'success' ? '#34a853' : 
                             type === 'error' ? '#ea4335' : '#f9ab00';
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function resetTodayData() {
            if (!confirm('Are you sure you want to reset today\'s attendance data? This cannot be undone!')) {
                return;
            }
            
            const today = getTodayString();
            attendanceData[today] = {};
            
            // Reset all staff status
            Object.keys(allStaffData).forEach(staffId => {
                allStaffData[staffId].status = "offline";
                allStaffData[staffId].lastActivity = null;
            });
            
            saveDatabase();
            updateDailyDisplay();
            showToast('Today\'s data has been reset', 'success');
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const staffId = document.getElementById('reportStaff').value;
            
            if (!startDate || !endDate) {
                showToast('Please select date range', 'error');
                return;
            }
            
            let actualStartDate = startDate;
            let actualEndDate = endDate;
            
            // Adjust dates based on report type
            if (reportType === 'weekly') {
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 7);
                actualStartDate = weekAgo.toISOString().split('T')[0];
                actualEndDate = getTodayString();
            } else if (reportType === 'monthly') {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                actualStartDate = firstDay.toISOString().split('T')[0];
                actualEndDate = getTodayString();
            }
            
            const reportData = generateReportData(actualStartDate, actualEndDate, staffId);
            displayReportResults(reportData, actualStartDate, actualEndDate);
        }

        function exportReportExcel() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const staffId = document.getElementById('reportStaff').value;
            
            if (!startDate || !endDate) {
                showToast('Please select date range', 'error');
                return;
            }
            
            let actualStartDate = startDate;
            let actualEndDate = endDate;
            
            if (reportType === 'weekly') {
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 7);
                actualStartDate = weekAgo.toISOString().split('T')[0];
                actualEndDate = getTodayString();
            } else if (reportType === 'monthly') {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                actualStartDate = firstDay.toISOString().split('T')[0];
                actualEndDate = getTodayString();
            }
            
            const reportData = generateReportData(actualStartDate, actualEndDate, staffId);
            exportReportToExcel(reportData, actualStartDate, actualEndDate, staffId);
        }
    </script>
</body>
</html>
